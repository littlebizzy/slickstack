<?php
/*
Plugin Name: XXX Common
Plugin URI: https://slickstack.io/mu-plugins/xxx-common
Description: Lightweight metadata plugin that displays a SlickStack drop-down menu and control panel area along with occasional notices about critical issues.
Version: 0.0.0
Author: SlickStack
Author URI: https://slickstack.io
License: GPLv3
License URI: http://www.gnu.org/licenses/gpl-3.0.html
Prefix: SSCOMM
*/

/** THIS LIGHTWEIGHT PHP SCRIPT HAS NO SQL QUERIES AND UPDATES DIRECTLY VIA SLICKSTACK */
/** IT IS A REQUIRED MU (MUST-USE) PLUGIN FOR SLICKSTACK (DO NOT REMOVE IT) */

/** ********************************************************************************************* */
/** XXX Common: SlickStack Login Message (Appears On Backend Login Page) ************************ */
/** ********************************************************************************************* */

/** this is a simple login page welcome message that we use to announce important things */
/** most of the time this feature will only be activated in case of emergencies */

if(WP_ENVIRONMENT_TYPE == 'production') {

	function ss_login_message_production() {
		return '<p class="message">Having trouble logging in? Please clear your browser cache and/or cookies for this site and try again. Thanks, and apologies! &mdash; <em>SlickStack</em></p>';
	}
	
	add_filter('login_message', 'ss_login_message_production');

}

if(WP_ENVIRONMENT_TYPE == 'staging') {
 
	function ss_login_message_staging() {
		return '<p class="message">Remember that all user logins on your staging site should be the same (i.e. synced) as they exist on your production site. &mdash; <em>SlickStack</em></p>';
	}

	add_filter('login_message', 'ss_login_message_staging');
}

if(WP_ENVIRONMENT_TYPE == 'development') {
 
	function ss_login_message_development() {
		return '<p class="message">First time logging in to this dev site? The default username/password should be the same as your SFTP login credentials. &mdash; <em>SlickStack</em></p>';
	}

	add_filter('login_message', 'ss_login_message_development');
}

/** ********************************************************************************************* */
/** XXX Common: SlickStack WP Admin Notices (Production) **************************************** */
/** ********************************************************************************************* */

add_action('admin_notices', 'ss_admin_notice_production_one');

function ss_admin_notice_production_one() {

    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>
    
    <div class="notice notice-info">
    <p><strong>Help us reach 10+ reviews on SourceForge</strong></p>
    <p>We hope you are enjoying SlickStack, and the stability and security that it brings to your WordPress website. As a free software project, the only way we grow is by word of mouth. Please consider leaving an honest review on <a href="https://sourceforge.net/software/product/SlickStack/"><strong>SourceForge</strong></a> if you would like our project to continue growing and getter better during 2022... your encouragement and feedback is truly the only thing keeping us going. And thank you, ahead of time!</p>
    
    <p><em>This message will disappear automatically after a few days, thank you. — SlickStack</em></p>
    
    </div>
    
    <?php } else { }

}

    
// add_action('admin_notices', 'ss_admin_notice_production_two');

function ss_admin_notice_production_two() {

    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>
    
    <div class="notice notice-warning">
    
    <p><strong>Nov 2, 2020:</strong> We are excited to announce that both <strong>STAGING</strong> and <strong>DEV</strong> sites will soon be supported on all servers as a subdomain for easy management (e.g. <code>staging.example.com</code> and <code>dev.example.com</code>). The reason we are moving to a subdomain approach rather than subdirectories is that it decreases potential conflicts with user logins, and improves security and usability. As a reminder, pushing from staging back to production is not currently supported, and we will also be adding a "timer" (clock) to your staging site so you know how much time is left before latest data overwrites from your production (live) site, approximately every 12 hours. The <strong>DEV</strong> sites will be launched very soon, which will allow your team to experiment with independent web design projects that are never synced or overwritten (in effect, it is a playground). More soon, cheers!</p>
    
    <p><em>Want to get a head start? Login to your CloudFlare DNS account and add new subdomain records for "staging" and "dev" that point to this server's IP address.</em></p>
    
    <p><em>This message will disappear automatically after a few days, thank you. — SlickStack</em></p>
    
    </div>

    <?php } else { }
}


// add_action('admin_notices', 'ss_admin_notice_production_three');

function ss_admin_notice_production_three() {

    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>
    
    <div class="notice notice-warning">
    <p><strong>Nov 20, 2020:</strong> We've added all <strong>MailChimp</strong> related plugins to our "warn" list due to their company's aggressive censorship and deplatforming of users, which is preventing many websites from contacting their users (often without any forewarning). We highly recommend using alternative email newsletters instead, such as YMLP, ConvertKit, ActiveCampaign, Constant Contact, Drip, and dozens of others that are politically neutral and very easy to use. If your company uses a CRM system like Hubspot or InfusionSoft, those will also manage all emailing for you. You can also use an email API such as SendGrid, Mailgun, Mailjet, etc to have even more flexibility, and connect their API with an open source newsletter app like MailPoet for WordPress (or with non-WordPress applications).</p>
    
    <p><em>This message will disappear automatically after a few days, thank you. — SlickStack</em></p>
    
    </div>
    
    <?php } else { }

}


// add_action('admin_notices', 'ss_admin_notice_production_four');

function ss_admin_notice_production_four() {

    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>
    
    <div class="notice notice-warning">
    <p><strong>Nov 25, 2020:</strong> We've immediately added <strong>Ultimate Member</strong> to our plugin blacklist due to complex malware infections affecting sites that have UM installed (the malware can spread and infect other plugins too, it looks like). In general it is a bad idea (bad practice) to install plugins that "replace" the native user registration functions of WordPress. Instead of hijacking user registration with third party code, always try to use the native user management that WordPress provides, but use add-ons to create user metadata instead (e.g. WooCommerce, Members by Justin Tadlock, etc). We've also immediately added <strong>Yoast SEO Premium</strong> to our blacklist after discovering multiple websites that had their 301 redirects either hijacked or messed up in the database to the point where manual database "surgery" was required to get the site back to a functional state. If you love Yoast then please stick with Yoast SEO (not Premium) which does not have the auto-redirect features included. In the future, we will likely be recommending users to avoid Yoast entirely in favor of more lightweight SEO plugins such as SEO Press, SEO Framework, and Slim SEO. Our free plugin SEO Genius will also be released sometime next year. For a reliable solution to 301/302 redirects please try the plugin <strong>Safe Redirect Manager</strong> released by 10up.</p>
    
    <p><em>This message will disappear automatically after a few days, thank you. — SlickStack</em></p>
    
    </div>
    
    <?php } else { }

}

/** ********************************************************************************************* */
/** XXX Common: SlickStack WP Admin Notices (Staging) ******************************************* */
/** ********************************************************************************************* */

/** Admin Notices (Staging) */

add_action('admin_notices', 'ss_admin_notices_staging');

function ss_admin_notices_staging() {
    $current_user = wp_get_current_user();
    $environment = WP_ENVIRONMENT_TYPE;
    if(current_user_can('manage_options') && $environment == 'staging') { ?>

    <div class="notice notice-warning">
    <p><strong>FOR STAGING PURPOSES ONLY:</strong> You are now browsing a temporary staging site, created automagically from your live production site. Data is continuously synced every 12 hours and will overwrite existing data (i.e. all staging files/database) unless you pause syncing. Please use this site to briefly test new plugins, themes, or features, and not for long-term web design work or publishing content. Both sites share the <code>/uploads/</code> directory from the production site to save disk space and avoid conflicts, so be sure not to upload any media files here. To avoid conflicts and reduce database bloat, it is best not to push your staging database to your production site (instead, you can simply replicate successful "staging" features on your production site); however, if you do push your staging site live, keep in mind that only <strong>Plugins</strong>, <strong>Themes</strong>, and the <code>wp_options</code> table will be pushed, and nothing else (this process will overwrite the Plugins, Themes, and <code>wp_options</code> table on your production site). ALL OTHER FILES AND MYSQL TABLES WILL BE IGNORED WHEN PUSHING FROM STAGING TO PRODUCTION.</p>
    <p>The following functions are installed by default: <em>Disable Emails</em>, <em>Disable WP Cron</em>, and <em>Disable Default Runner (WooCommerce Scheduler)</em>.</p>
    <br class="clear" />
    <a class="button" href="#">Pause Syncing</a>
    </div>

    <?php } else { }
}

/** ********************************************************************************************* */
/** XXX Common: SlickStack Dashboard (WP Admin) ************************************************* */
/** ********************************************************************************************* */

/** this lightweight control panel diplays current SlickStack settings to admin users only */
/** there are no SQL queries and settings are controlled by PHP defined constants */

function ss_menu() {
    if (defined('SS_WORDPRESS_ADMIN_DASHBOARD') && (SS_WORDPRESS_ADMIN_DASHBOARD == false) ) {
        // do nothing
    }
    else {
        add_menu_page(
            'SlickStack Settings',
            '@WHITELABEL_BRAND',
            'manage_options',
            'slickstack',
            'ss_menu_content',
            'dashicons-admin-generic',
            1
        );
    }
}

 add_action('admin_menu', 'ss_menu');


// generates content to display on the control panel page

 function ss_menu_content() {
    echo '<div class="wrap">
    <h1>@WHITELABEL_BRAND Settings</h1><!-- <p>Because SlickStack is designed for performance and security, most of the below settings are modified using defined constants (PHP) instead of being saved to your MySQL database (which is slower and less secure). Also keep in mind that these features and metadata are powered by our default MU (Must-Use) plugins for WordPress, therefore if you customize your SlickStack server, these features may no longer be supported. In order to modify these settings, <a href="/wp-admin/plugins.php?page=custom-functions">add relevant snippets</a> as custom functions: <code>/wp-content/functions.php</code></p> -->';
    
  //Get the active tab from the $_GET param
  $default_tab = null;
  $tab = isset($_GET['tab']) ? $_GET['tab'] : $default_tab;
  
  ?>
         
    <nav class="nav-tab-wrapper">
      <a href="?page=slickstack" class="nav-tab <?php if($tab===null):?>nav-tab-active<?php endif; ?>">General</a>
      
      <?php if(MULTISITE != 'true'){ ?>
      <a href="?page=slickstack&tab=sftp" class="nav-tab <?php if($tab==='sftp'):?>nav-tab-active<?php endif; ?>">SFTP</a>
      <a href="?page=slickstack&tab=database" class="nav-tab <?php if($tab==='database'):?>nav-tab-active<?php endif; ?>">Database</a>
      <a href="?page=slickstack&tab=error-log" class="nav-tab <?php if($tab==='error-log'):?>nav-tab-active<?php endif; ?>">Error Log</a>
      <a href="?page=slickstack&tab=caching" class="nav-tab <?php if($tab==='caching'):?>nav-tab-active<?php endif; ?>">Caching</a>
      <?php } ?>
      
      <a href="?page=slickstack&tab=backups" class="nav-tab <?php if($tab==='backups'):?>nav-tab-active<?php endif; ?>">Backups</a>
      <a href="?page=slickstack&tab=billing" class="nav-tab <?php if($tab==='billing'):?>nav-tab-active<?php endif; ?>">Billing</a>
      <a href="?page=slickstack&tab=support" class="nav-tab <?php if($tab==='support'):?>nav-tab-active<?php endif; ?>">Support</a>
      
    </nav><!-- nab-tab-wrapper -->

    <div class="tab-content">
	
    <?php switch($tab) :
    
    
	case 'backups':
	
		echo '<br class="clear" />
		<p>Coming soon... powered by Rclone! Choose from Backblaze, Dropbox, Amazon S3, Google Drive, and more...</p>';
        
	break;
	
	
	case 'billing':
	
		echo '<br class="clear" />
		<p>Coming soon... easy automatic billing options for web agencies.</p>';
        
	break;
	
	
	case 'support':
	
		echo '<br class="clear" />
		<h2>Get Support</h2>
		<p>We are available to help you with your server, please contact using below methods:</p>
		
		<ul>
		<li>Support requests: <code>' . WHITELABEL_SUPPORT_URL . '</code></li>
		<li>Support email: <code>' . WHITELABEL_SUPPORT_EMAIL . '</code></li>
		</ul>
		
		<br class="clear" />';
        
	break;
	
	
	case 'sftp':
	
	if(MULTISITE != 'true'){
	
		$ip_server = $_SERVER['SERVER_ADDR'];

		echo '<br class="clear" />
		<h2>SFTP Details</h2>
		
		<ul>
		<li>Website: <code>' . WP_HOME . '</code></li>
		<li>Server (host): <code>' . $ip_server . '</code></li>
		<li>SFTP user: <code>' . SFTP_USER . '</code></li>
		<li>SFTP password: <code>' . SFTP_PASSWORD . '</code></li>
		<li>SFTP port: <code>' . SFTP_PORT . '</code></li>
		<li>Root Directory: <code>/var/www</code></li>
		<li>Public Directory: <code>/var/www/html</code></li>
		</ul>
		
		<br class="clear" />
		<p><em>You must choose the SFTP protocol when connecting (not FTP or FTPS) on the port number listed above.</em></p>
		<br class="clear" />
		<a class="button" href="#">Reset SFTP Password</a>';
		
	} // end if
        
	break;
	
	
	case 'database':
		
    echo '<br class="clear" />
		<h2>Database Access</h2>
		<ul>
		<li>Database host: <code>' . DB_HOST . '</code></li>
		<li>Database name: <code>' . DB_NAME . '</code></li>
		<li>Database user: <code>' . DB_USER . '</code></li>
		<li>Database password: <code>' . DB_PASSWORD . '</code></li>
		</ul>
		<br class="clear" />
		<a class="button" href="/adminer?username=' . DB_USER . '&db=' . DB_NAME . '&server=' . DB_HOST . '" target="_blank" rel="noopener noreferrer">Open Adminer (new window)</a>';
        
		break;
	
	
	case 'error-log':
		
    echo '<br class="clear" />
		<h2>Error Log</h2>
		<p>Below are the most recent (<em>E_ERROR</em>, <em>E_WARNING</em>, <em>E_PARSE</em>) lines from the PHP error log: <code>/var/www/logs/error.log</code></p>
		<div style="overflow-x: scroll;"><pre>';

    function lastLines($file, $lines) {
        $size = filesize($file);
      $fd=fopen($file, 'r+');
      $pos = $size;
      $n=0;
      
                        while ( $n < $lines+1 && $pos > 0) {
        fseek($fd, $pos);
        $a = fread($fd, 1);
                if ($a === "\n") {
                        ++$n;
                };
        $pos--;
        }
        // $array = array_reverse($array);                      
        $ret = array();
                for ($i=0; $i<$lines; $i++) {
                array_push($ret, fgets($fd));
                }
		
	$retrev = array_reverse($ret);
        
	return $retrev;
    }
    
    print_r(implode(lastLines('/var/www/logs/error.log', 999)));

    echo '</pre></div> 
    <br class="clear" />
    <a class="button" href="#">Clear Error Log</a>';

		break;
		
		
        	case 'caching':
		
        	echo '<br class="clear" />
		<h2>Cache Settings</h2>
		<p><strong>PHP OPcache:</strong> ' . (is_array(opcache_get_status()) ? 'enabled' : 'disabled') . '</p>
		<br class="clear" />
        	<p><a href="/wp-admin/options-general.php?page=clear-caches">Click here for Clear Caches settings (same window)</a></p>';
        	
		break;
		
	
	case 'blacklist':
		
    echo '<br class="clear" />
		<h2>Plugin Blacklist Settings</h2>
		<p>In order to protect websites from WordPress plugins that are known to have security or stability issues, we have implemented a plugin blacklist.</p>
		<p><strong>Blacklist Status:</strong> <code>' . json_encode(SS_WORDPRESS_PLUGIN_BLACKLIST) . '</code></p>
		<p><strong>Blacklist Source File:</strong> <a href="' . SS_WORDPRESS_PLUGIN_BLACKLIST_SOURCE . '">Click to view blacklist &raquo;</a></p>';
        
		break;
		
		
		
		case 'seo':
		
        	echo '<br class="clear" />
		<h2>SEO Settings</h2>
		<p><strong>404 to homepage:</strong> <code>' . FOURZEROFOUR_TO_HOMEPAGE . '</code></p>
		<p><strong>Disable author pages:</strong> <code>' . DISABLE_AUTHOR_PAGES . '</code></p>
		<p><strong>Disable attachment pages:</strong> <code>' . DISABLE_ATTACHMENT_PAGES . '</code></p>
		<p><strong>Disable search:</strong> <code>' . DISABLE_SEARCH . '</code></p>
		<p><strong>Enable subtitles:</strong> <code>' . ENABLE_SUBTITLES . '</code></p>
		<p><strong>Header cleanup:</strong> <code>' . HEADER_CLEANUP . '</code></p>
		<p><strong>Noindex tags:</strong> <code>' . NOINDEX_TAGS . '</code></p>
		<p><strong>Remove category base:</strong> <code>' . REMOVE_CATEGORY_BASE . '</code></p>
		<p><strong>Virtual robots.txt:</strong> <code>' . VIRTUAL_ROBOTSTXT . '</code></p>
		<p><strong>XML sitemap:</strong> <code>' . XML_SITEMAP . '</code></p>
		<br class="clear" />
        	<p><em>Optional SEO settings powered by the free SEO Genius plugin coming soon</em></p>';
        	
		break;
		
		
		case 'cloudflare':
		
        	echo '<br class="clear" />
		<h2>CloudFlare Settings</h2>
		<p><strong>CloudFlare API Key:</strong> <code>' . CLOUDFLARE_API_KEY . '</code></p>
		<p><strong>CloudFlare API Email:</strong> <code>' . CLOUDFLARE_API_EMAIL . '</code></p>
		<br class="clear" />
        	<p><a href="/wp-admin/options-general.php?page=cloudflare">Click here for CloudFlare settings (same window)</a></p>';
        	
		break;
        
      case 'minify':  
    echo '<h4>Minify HTML settings:</h4><p><strong>Minify HTML status:</strong> <?php echo MINIFY_HTML; ?></p>
    <p><strong>Minify HTML inline styles:</strong> <?php echo MINIFY_HTML_INLINE_STYLES; ?></p>
    <p><strong>Minify HTML inline styles (comments):</strong> <?php echo MINIFY_HTML_INLINE_STYLES_COMMENTS; ?></p>
    <p><strong>Minify HTML remove comments:</strong> <?php echo MINIFY_HTML_REMOVE_COMMENTS; ?></p>
    <p><strong>Minify HTML remove conditionals:</strong> <?php echo MINIFY_HTML_REMOVE_CONDITIONALS; ?></p>
    <p><strong>Minify HTML remove extra spacing:</strong> <?php echo MINIFY_HTML_REMOVE_EXTRA_SPACING; ?></p>
    <p><strong>Minify HTML remove HTML5 self closing:</strong> <?php echo MINIFY_HTML_REMOVE_HTML5_SELF_CLOSING; ?></p>
    <p><strong>Minify HTML remove line breaks:</strong> <?php echo MINIFY_HTML_REMOVE_LINE_BREAKS; ?></p>
    <p><strong>Minify HTML inline scripts:</strong> <?php echo MINIFY_HTML_INLINE_SCRIPTS; ?></p>
    <p><strong>Minify HTML inline scripts (comments):</strong> <?php echo MINIFY_HTML_INLINE_SCRIPTS_COMMENTS; ?></p>
    <p><strong>Minify HTML UTF8 support:</strong> <?php echo MINIFY_HTML_UTF8_SUPPORT; ?></p>';
        break;
        
      		default:
		
		$ss_os = PHP_OS_FAMILY;
		
		$ss_cpu = 1;
		if(is_file('/proc/cpuinfo')) {
    		$cpuinfo = file_get_contents('/proc/cpuinfo');
    		preg_match_all('/^processor/m', $cpuinfo, $matches);
    		$ss_cpu = count($matches[0]);
		}
      
        	echo '<br class="clear" />
		<h2>General Settings</h2>
		<p><strong>SlickStack Build:</strong> ' . SS_BUILD . '</p>
		<p><strong>Hardware (Datacenter) Vendor:</strong> ' . SYSTEM_VENDOR . '</p>
		<p><strong>Virtualization Technology:</strong> ' . SYSTEM_VIRTUAL . '</p>
		<p><strong>Linux Kernel:</strong> ' . SYSTEM_LINUX_KERNEL . '</p>
		<p><strong>Operating System:</strong> ' . SYSTEM_OS_PRETTY_NAME . '</p>
		<p><strong>IP Address (IPv4):</strong> ' . SYSTEM_IPV4_ADDRESS . '</p>
		<p><strong>IP Address (IPv6):</strong> ' . SYSTEM_IPV6_ADDRESS . '</p>
		<p><strong>Hostname:</strong> ' . SYSTEM_HOSTNAME . '</p>
		<p><strong>Disk Space:</strong> % used (' . SYSTEM_DISK_FREE . 'B available space remaining out of ' . SYSTEM_DISK_TOTAL . ' GB total space)</p>
		<p><strong>CPU Cores:</strong> ' . SYSTEM_CPU_CORES . ' cores (virtual)</p>
		<p><strong>Nginx Version:</strong> ' . SYSTEM_SERVER_SOFTWARE . '</p>
		<p><strong>PHP Version:</strong> ' . SYSTEM_PHP_VERSION . '</p>
		<p><strong>PHP Extensions:</strong> ' . SYSTEM_PHP_EXTENSIONS . '</p>
		<p><strong>MySQL Version:</strong> ' . SYSTEM_MYSQL_VERSION . '</p>
		<p><strong>MySQL Database(s) Size:</strong> ' . SYSTEM_MYSQL_SIZE . '</p>
		<br class="clear" />
		<br class="clear" />
		<p>Are you a developer? This data is sourced from: <code>/var/www/meta/ss-constants.php</code></p>';
        
		break;
		
    endswitch; ?>
    </div><!-- tab-content -->

    <?php echo '</div><!-- wrap -->';
}

/** ********************************************************************************************* */
/** XXX-Common: SlickStack Server Resources Notices (WP Admin) ********************************** */
/** ********************************************************************************************* */

// add_action('admin_notices', 'ss_notices_resources');

/*
function ss_notices_resources() {
    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>

    <div class="notice notice-error">
    <p>Server CPU usage is consistently high, consider upgrading your server.</p>
    <p>Server RAM memory usage is consistently high, consider upgrading your server.</p>
    <p>Server disk spage is running out, consider upgrading your server.</p>
    <p><em>This message will disappear automatically after a few days, thank you. — SlickStack</em></p>
    </div>

    <?php } else { }
}
*/

/** ********************************************************************************************* */
/** XXX-Common: SlickStack Non-Critical WP Admin Notices **************************************** */
/** ********************************************************************************************* */

/** SlickStack Admin Notices */
// if plugin or theme files found to be hacking PHP ini or error handling settings

/** ********************************************************************************************* */
/** XXX-Common: SlickStack WP Admin Sidebar Menu (Control Panel Settings) *********************** */
/** ********************************************************************************************* */



/** ********************************************************************************************* */
/** XXX-Common: SlickStack WP Admin Toolbar Menu (Shortcuts) ************************************ */
/** ********************************************************************************************* */

/** SlickStack Toolbar Shortcuts */
// add_action('admin_bar_menu', 'slickstack_menu', 25);

function slickstack_menu() {
    if(current_user_can('manage_options') ) {
        global $wp_admin_bar;
        $ss_menu = 'slickstack-menu';
        $home_url = home_url();
        $home_domain = str_replace(array('https://', ''), array('http://', ''), $home_url);
        $homeurl_input = home_url();   
        $homeurl_clean = preg_replace( "#^[^:/.]*[:/]+#i", "", preg_replace( "{/$}", "", urldecode( $homeurl_input ) ) ); 
        $dnssec_refer = 'https://dnssec-analyzer.verisignlabs.com/'. $homeurl_clean .'';
        $ssllabs_refer = 'https://www.ssllabs.com/ssltest/analyze.html?d='. $home_url .'&latest';
        $gtmetrix_refer = 'https://gtmetrix.com/?url='. $home_url .'&location=2';
        $security_headers_refer = 'https://securityheaders.com/?q='. $home_url .'&hide=on&followRedirects=on';
        $pagespeed_refer = 'https://developers.google.com/speed/pagespeed/insights/?url='. $home_url .'';
        $mobilefriendly_refer = 'https://search.google.com/test/mobile-friendly?url='. $home_url .'';
        $ipv6_refer = 'https://www.ultratools.com/tools/ipv6reportsResult?hostName='. $homeurl_clean .'';
        $blackspam_refer = 'https://mxtoolbox.com/SuperTool.aspx?action=blacklist%3a'. $homeurl_clean .'&run=toolpage';
        $intodns_refer = 'https://intodns.com/'. $homeurl_clean .'';
        $mxrecord_refer = 'https://mxtoolbox.com/SuperTool.aspx?action=mx%3a'. $homeurl_clean .'&run=toolpage';
	$mimecast_refer = 'https://www.dmarcanalyzer.com/dmarc/dmarc-record-check/?dmarcdns%5Btype%5D=dmarc&dmarcdns%5Bdomain%5D='. $homeurl_clean .'';
	$immuniweb_refer = 'https://www.immuniweb.com/websec/?id='. $home_url .'';
        $wp_admin_bar->add_menu( array('id' => $ss_menu, 'title' => 'SlickStack', 'href' => '/wp-admin/admin.php?page=slickstack') );
        // $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-adminer', 'title' => 'Adminer (phpMyAdmin)', 'href' => '/adminer', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-homepage', 'title' => 'SlickStack.io portal',  'href' => 'https://slickstack.io', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-faq', 'title' => 'General FAQ',  'href' => 'https://slickstack.io/faq', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-mirrors', 'title' => 'Public mirrors', 'href' => 'https://mirrors.slickstack.io', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-issue', 'title' => 'Report an issue (bug)', 'href' => 'https://github.com/littlebizzy/slickstack/issues/new', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-github', 'title' => 'GitHub repo', 'href' => 'https://github.com/littlebizzy/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-newsletter', 'title' => 'Email newsletter',  'href' => 'https://cdn.forms-content.sg-form.com/6ba39413-e148-11ea-b64b-d22850ff1ee7', 'meta' => array('target' => '_blank') ) );
		$wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-chat-rooms', 'title' => 'Free chat rooms',  'href' => false) );
			$wp_admin_bar->add_menu( array('parent' => 'ss-menu-chat-rooms', 'id' => 'ss-menu-discord-server', 'title' => 'Discord server',  'href' => 'https://discord.gg/nGskJdg', 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss-menu-chat-rooms', 'id' => 'ss-menu-matrix-room', 'title' => 'Matrix room (public)',  'href' => 'https://app.element.io/#/room/#general:matrix.slickstack.io', 'meta' => array('target' => '_blank') ) );
			$wp_admin_bar->add_menu( array('parent' => 'ss-menu-chat-rooms', 'id' => 'ss-menu-skype-chat', 'title' => 'Skype group chat',  'href' => 'https://join.skype.com/NdpqKrN2BHdN', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss_menu_benchmark', 'title' => 'Benchmarking tools',  'href' => false) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-secheaders', 'title' => 'Security Headers (By Scott Helme)',  'href' => $security_headers_refer, 'meta' => array('target' => '_blank') ) );
			$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-gtmetrix', 'title' => 'GTmetrix (By Carbon60)',  'href' => $gtmetrix_refer, 'meta' => array('target' => '_blank') ) );
			$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-dnssec', 'title' => 'DNSSEC Analyzer (By VeriSign)',  'href' => $dnssec_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-pagespeed', 'title' => 'PageSpeed Insights (By Google)',  'href' => $pagespeed_refer, 'meta' => array('target' => '_blank') ) );
			$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-ssllabs', 'title' => 'SSL Test (By Qualys SSL Labs)',  'href' => $ssllabs_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-mobfriendly', 'title' => 'Mobile-Friendly Test (By Google)',  'href' => $mobilefriendly_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-blackspam', 'title' => 'Blacklist (Spam) Check (By MxToolbox)',  'href' => $blackspam_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-ipv6', 'title' => 'IPv6 Compatibility (By Neustar)',  'href' => $ipv6_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-intodns', 'title' => 'DNS Lookup (By IntoDNS)',  'href' => $intodns_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-mxrecord', 'title' => 'MX Lookup (By MxToolbox)',  'href' => $mxrecord_refer, 'meta' => array('target' => '_blank') ) );
        	$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-dmarc', 'title' => 'DMARC Lookup (By Mimecast)',  'href' => $mimecast_refer, 'meta' => array('target' => '_blank') ) );
		$wp_admin_bar->add_menu( array('parent' => 'ss_menu_benchmark', 'id' => 'ss-menu-immuniweb', 'title' => 'Web Security Test (By ImmuniWeb)',  'href' => $immuniweb_refer, 'meta' => array('target' => '_blank') ) );
		$wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-reviews', 'title' => 'Review SlickStack',  'href' => false) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-facebook', 'title' => 'Review on Facebook',  'href' => 'https://www.facebook.com/slickstack/reviews', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-producthunt', 'title' => 'Review on Product Hunt',  'href' => 'https://www.producthunt.com/posts/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-capterra', 'title' => 'Review on Capterra',  'href' => 'https://www.capterra.com/p/211436/SlickStack/', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-stackshare', 'title' => 'Review on StackShare',  'href' => 'https://stackshare.io/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-saashub', 'title' => 'Review on SaaSHub',  'href' => 'https://www.saashub.com/slickstack-alternatives', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-g2-crowd', 'title' => 'Review on G2 Crowd',  'href' => 'https://www.g2.com/products/slickstack/reviews', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-alternativeme', 'title' => 'Review on Alternative.me',  'href' => 'https://alternative.me/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-alternativeto', 'title' => 'Review on AlternativeTo',  'href' => 'https://alternativeto.net/software/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-wappalyzer', 'title' => 'Review on Wappalyzer',  'href' => 'https://www.wappalyzer.com/technologies/development/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-slant', 'title' => 'Review on Slant',  'href' => 'https://www.slant.co/improve/options/35681/~slickstack-review', 'meta' => array('target' => '_blank') ) );
    } else { }
}
    
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Client Login'), 'id' => 'slickstack-account', 'href' => 'https://www.littlebizzy.com/account', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('CloudFlare Login'), 'id' => 'slickstack-cloudflare', 'href' => 'https://dash.cloudflare.com/login', 'meta' => array('target' => '_blank')));   
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('CodeGuard Login'), 'id' => 'slickstack-codeguard', 'href' => 'https://www.codeguard.com/login', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('New Support Ticket'), 'id' => 'slickstack-support', 'href' => 'https://www.littlebizzy.com/contact', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Facebook Chat'), 'id' => 'slickstack-messenger', 'href' => 'https://m.me/littlebizzy', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Telegram Channel'), 'id' => 'slickstack-telegram', 'href' => 'https://t.me/littlebizzy', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('FAQ'), 'id' => 'slickstack-faq', 'href' => 'https://www.littlebizzy.com/faq', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Disallowed Plugins'), 'id' => 'slickstack-blacklist', 'href' => 'http://mirrors.slickstack.io/wordpress/blacklist.txt', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Recommended Plugins'), 'id' => 'slickstack-rec-plugins', 'href' => 'https://www.littlebizzy.com/faq/recommended-plugins', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Recommended Themes'), 'id' => 'slickstack-rec-themes', 'href' => 'https://www.littlebizzy.com/faq/recommended-themes', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('User Guide'), 'id' => 'slickstack-guide', 'href' => 'https://www.littlebizzy.com/guide', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Free Plugins'), 'id' => 'slickstack-plugins', 'href' => 'https://www.littlebizzy.com/plugins', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('DevOps Services'), 'id' => 'slickstack-services', 'href' => 'https://www.littlebizzy.com/services', 'meta' => array('target' => '_blank')));

/** ********************************************************************************************* */
/** XXX-Common: SlickStack WP Admin Toolbar Menu (Staging Switcher) ***************************** */
/** ********************************************************************************************* */

/** Toolbar Switcher (Production) */
// Future: replace this janky thing with a defined constant
//@STAGING_SITE_TRUE//

add_action('admin_bar_menu', 'ss_environment_menu', 25);

function ss_environment_menu($admin_bar) {
    
    // global $wp_admin_bar;
    
    $current_user = wp_get_current_user();
    
    $ss_production_link = home_url( $path = '', $scheme = 'https' );
    $ss_production_link = str_replace('staging.', '', $ss_production_link);
    $ss_production_link = str_replace('dev.', '', $ss_production_link);

    $ss_staging_link = str_replace('https://', 'https://staging.', $ss_production_link);
    $ss_staging_link_fixed = str_replace('www.', '', $ss_staging_link);
    
    $ss_dev_link = str_replace('https://', 'https://dev.', $ss_production_link);
    $ss_dev_link_fixed = str_replace('www.', '', $ss_dev_link);
    
    if(current_user_can('manage_options')) {
    
        if(WP_ENVIRONMENT_TYPE == 'staging') {
        
            // current environment
            $admin_bar->add_menu( array(
                'parent' => 'top-secondary',
                'id'    => 'ss_environment_current',
                'title' => '<span style="color:#FFBA00;">STAGING</span>',
                'href'  => false
                ) );
            
        // Production Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_production',
            'title' => 'Switch To Production', 
            'href' => $ss_production_link, 
            'meta' => array('target' => '_blank')
            ) );
            
        // Dev Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Dev', 
            'href' => $ss_dev_link_fixed, 
            'meta' => array('target' => '_blank')
            ) );
            
        } // end if staging
        
        elseif(WP_ENVIRONMENT_TYPE == 'development') {
                
        // Current Environment
        $admin_bar->add_menu( array(
            'parent' => 'top-secondary',
            'id'    => 'ss_environment_current',
            'title' => '<span style="color:#dc3232;">DEVELOPMENT</span>',
            'href'  => false
            ) );
            
        // Production Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_production',
            'title' => 'Switch To Production', 
            'href' => $ss_production_link, 
            'meta' => array('target' => '_blank')
            ) );
            
        // Staging Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Staging', 
            'href' => $ss_staging_link_fixed, 
            'meta' => array('target' => '_blank')
            ) );
            
        } // end elseif dev
        
        else {
        
        // Current Environment
        $admin_bar->add_menu( array(
            'parent' => 'top-secondary',
            'id'    => 'ss_environment_current',
            'title' => '<span style="color:#3CB54C;">PRODUCTION</span>',
            'href'  => false
            ) );
            
        // Staging Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_staging',
            'title' => 'Switch To Staging', 
            'href' => $ss_staging_link_fixed, 
            'meta' => array('target' => '_blank')
            ) );
            
        // Dev Link
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Dev', 
            'href' => $ss_dev_link_fixed, 
            'meta' => array('target' => '_blank')
            ) );
            
        } // end else (production)
        
    } else { }
}


/** ********************************************************************************************* */
/** SlickStack: External References Used To Improve This Script (Thanks, Interwebz) ************* */
/** ********************************************************************************************* */

// Ref: https://www.digitalocean.com/community/questions/enable-php-5-5-opcache-on-ubuntu-14-04-with-nginx-and-php-fpm
// Ref: https://stackoverflow.com/questions/15025875/what-is-the-best-way-in-php-to-read-last-lines-from-a-file
// Ref: https://stackoverflow.com/questions/4948663/php-get-bool-to-echo-false-when-false

// SS_EOF
