#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: littlebizzy/slickstack/blob/master/bash/ss-import-database.txt ########################
#### path: /var/www/ss-import-database #############################################################
#### destination: n/a (static file) ################################################################
#### purpose: Force imports /tmp/import.sql|.sql.zip|.sql.gz and overwrites database ###############
#### module version: Ubuntu 18.04-24.04 LTS + MySQL 5.7-8.0 ########################################
#### sourced by: n/a ###############################################################################
#### bash aliases: ss import database|db ###########################################################
####################################################################################################

####################################################################################################
#### TABLE OF CONTENTS (SS-Import-Database) ########################################################
####################################################################################################

## this is a brief summary of the different code snippets you will find in this script ##
## each section should be commented so you understand what is being accomplished ##

## A. Source SS-Config + SS-Functions
## B. Touch Timestamp File
## C. Message (Begin Script)
## D. Run SS-Dump-Database
## E. Import Database (Overwrites Data)

####################################################################################################
#### A. SS-Import-Database: Source SS-Config + SS-Functions ########################################
####################################################################################################

## before anything else we must source the critical variables that power this script ##
## ss-config is setup during ss-install wizard but ss-functions is hardcoded ##

## source ss-config ##
source /var/www/ss-config

## source ss-functions ##
source /var/www/ss-functions

## BELOW THIS RELIES ON SS-CONFIG AND SS-FUNCTIONS

####################################################################################################
#### B. SS-Import-Database: Touch Timestamp File ###################################################
####################################################################################################

## this is a dummy timestamp file that will remember the last time this script was run ##
## it can be useful for developer reference and is sometimes used by SlickStack ##

ss_touch "${TIMESTAMP_SS_IMPORT_DATABASE}"

####################################################################################################
#### C. SS-Import-Database: Message (Begin Script) #################################################
####################################################################################################

## this is a simple message that announces to the shell the purpose of this bash script ##
## it will only be seen by sudo users who manually run this script in the shell ##

ss_echo "${COLOR_INFO}Running ss-import-database... ${COLOR_RESET}"

####################################################################################################
#### D. SS-Import-Database: Run SS-Dump-Database ###################################################
####################################################################################################

## before overwriting the live production database we first dump the existing database ##
## this is an extra safety precaution to ensure a recent database dump exists ##

source "${PATH_SS_DUMP_DATABASE}"

####################################################################################################
#### E. SS-Import-Database: Import Database (Overwrites Data) ######################################
####################################################################################################

## here the sudo user must manually confirm importing database before it can proceed ##
## import.sql is the preferred file format followed by .sql.zip and .sql.gz ##

## confirm destructive database import ##
read -r -p "The database will be completely overwritten. Are you sure? [y/N] " response
if [[ "${response}" =~ ^[Yy]([Ee][Ss])?$ ]]; then

    ## import plain sql file if present and non-empty ##
    if [[ -s "/tmp/import.sql" ]]; then

        ss_echo "Found import.sql. Proceeding to overwrite the database."

        ## fix ownership and permissions ##
        ss_chown "${SFTP_USER}":slickstack /tmp/import.sql
        ss_chmod 0660 /tmp/import.sql

        ## import sql into database ##
        ss_mysql_user "${DB_NAME}" < /tmp/import.sql || {
            ss_echo "Database import failed."
            exit 1
        }

        ss_echo "Database import completed successfully."
        
    ## import zip archive if present ##
    elif [[ -f "/tmp/import.sql.zip" ]]; then

        ## verify zip integrity ##
        unzip -tq /tmp/import.sql.zip || {
            ss_echo "Zip file failed integrity check."
            exit 1
        }

        ## ensure zip contains data ##
        unzip -p /tmp/import.sql.zip | head -c 1 | grep -q . || {
            ss_echo "Zip file appears to be empty."
            exit 1
        }

        ss_echo "Found import.sql.zip. Proceeding to overwrite the database."

        ## fix ownership and permissions ##
        ss_chown "${SFTP_USER}":slickstack /tmp/import.sql.zip
        ss_chmod 0660 /tmp/import.sql.zip

        ## stream unzip and import into database ##
        unzip -p /tmp/import.sql.zip | ss_mysql_user "${DB_NAME}" || {
            ss_echo "Database import failed."
            exit 1
        }

        ss_echo "Database import completed successfully."
        
    ## import gzip archive if present ##
    elif [[ -f "/tmp/import.sql.gz" ]]; then

        ## verify gzip integrity ##
        gunzip -t /tmp/import.sql.gz || {
            ss_echo "Gzip file failed integrity check."
            exit 1
        }

        ## ensure gzip contains data ##
        gunzip -c /tmp/import.sql.gz | head -c 1 | grep -q . || {
            ss_echo "Gzip file appears to be empty."
            exit 1
        }

        ss_echo "Found import.sql.gz. Proceeding to overwrite the database."

        ## fix ownership and permissions ##
        ss_chown "${SFTP_USER}":slickstack /tmp/import.sql.gz
        ss_chmod 0660 /tmp/import.sql.gz

        ## stream gunzip and import into database ##
        gunzip -c /tmp/import.sql.gz | ss_mysql_user "${DB_NAME}" || {
            ss_echo "Database import failed."
            exit 1
        }

        ss_echo "Database import completed successfully."
                
    ## no valid import file found ##
    else

        ss_echo "No import.sql, import.sql.zip, or import.sql.gz file was found. The database cannot be imported."
        exit 1

    fi

## user cancelled import ##
else
    ss_echo "Database import cancelled."
    exit 1
fi

####################################################################################################
#### SlickStack: Reset Permissions (SlickStack Scripts) ############################################
####################################################################################################

## we include this permissions reset in all cron jobs and bash scripts for redundancy ##
## chmod 0700 means only the root/sudo users can execute any SlickStack scripts ##

## THIS SNIPPET DOES NOT RELY ON SS-CONFIG OR SS-FUNCTIONS
## SNIPPET: ss bash scripts, ss cron jobs
## UPDATED: 02JUL2022

chown root:root /var/www/ss* ## must be root:root
chown root:root /var/www/crons/*cron* ## must be root:root
chown root:root /var/www/crons/custom/*cron* ## must be root:root
chmod 0700 /var/www/ss* ## 0700 means only root/sudo can execute
chmod 0700 /var/www/crons/*cron* ## 0700 means only root/sudo can execute
chmod 0700 /var/www/crons/custom/*cron* ## 0700 means only root/sudo can execute

####################################################################################################
#### SlickStack: External References Used To Improve This Script (Thanks Interwebz) ################
####################################################################################################

## Ref: ChatGPT
## Ref: https://unix.stackexchange.com/questions/630495/what-is-set-group-id-on-execution-ignored-and-why-am-i-unable-to-unzip-a-file
## Ref: https://www.reddit.com/r/Ubuntu/comments/s39uyj/gzip_error_mydbsql_is_setgroupid_on_execution/

## SS_EOF
