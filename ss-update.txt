#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-update.txt ############################################
#### path: /var/www/ss-update ######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: Updates and cleans up SlickStack modules (Ubuntu packages) and WP extensions #########
#### module version: Ubuntu 18.04 LTS ##############################################################
####################################################################################################

## YOU CAN SAFELY RUN SS-UPDATE WITH NO EFFECT TO YOUR SLICKSTACK CONFIGURATION ##

## include SlickStack configuration ##
source /var/www/ss-config

####################################################################################################
#### SlickStack: Critical Bash Functions (Aliases) For This Script To Work #########################
####################################################################################################

## apt alias flags ##
function apt {
    export DEBIAN_FRONTEND=noninteractive
    export DEBIAN_PRIORITY=critical
    export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
    command /usr/bin/apt -q -y -o Dpkg::Options::=--force-confold -o Dpkg::Options::=--force-confdef "$@"
}

## add-apt-repository alias flags ##
function add-apt-repository {
    export DEBIAN_FRONTEND=noninteractive
    export DEBIAN_PRIORITY=critical
    export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
    command /usr/bin/add-apt-repository -y "$@"
}

## wget alias flags ##
function wget {
    command wget --no-check-certificate --no-cache --no-cookies --tries=3 --timeout=15 "$@"
}

## cp alias flags ##
function cp {
    command cp -R -f -d --no-preserve=mode,ownership "$@"
}

## mkdir alias flags ##
function mkdir {
    command mkdir -p "$@"
}

## unzip alias flags ##
function unzip {
    command unzip -o "$@"
}

## rm alias flags ##
function rm {
    command rm -R -f "$@"
}

####################################################################################################
#### SS-Update: Backup MySQL Database Before Proceeding (Via SS-Dump) ##############################
####################################################################################################

## run ss-dump ##
source /var/www/ss-dump

####################################################################################################
#### SS-Update: Set Confold As Ubuntu Dpkg Default (When Upgrading Any Packages) ###################
####################################################################################################

## set confold as the dpkg default choice ##
DEBIAN_FRONTEND=noninteractive dpkg --configure -a --force-confold

####################################################################################################
#### SS-Update: Update MU (Must-Use) Plugins (Via SS-Muplugs) ######################################
####################################################################################################

## run ss-muplugs ##
source /var/www/ss-muplugs

####################################################################################################
#### SS-Update: Upgrade + Autoremove + Autoclean SlickStack Modules (Ubuntu Packages) ##############
####################################################################################################

## update Ubuntu repo cache ##
apt update

## upgrade installed Ubuntu packages (SlickStack LEMP modules) ##
apt full-upgrade

## autoremove Ubuntu packages ##
apt autoremove

## autoclean Ubuntu packages ##
apt autoclean

####################################################################################################
#### SS-Update: Purge All Caches (Via SS-Purge) ####################################################
####################################################################################################

## run ss-purge ##
source /var/www/ss-purge

####################################################################################################
#### SS-Update: Restart All Services (Via SS-Restart) ##############################################
####################################################################################################

## run ss-restart ##
source /var/www/ss-restart

####################################################################################################
#### SS-Update: Reboot Server Automatically (Optional In SS-Config) ################################
####################################################################################################

## IT IS ALWAYS BETTER TO RUN SS-UPDATE MANUALLY AND REBOOT YOUR SERVER MANUALLY ##

if [[ "$SS_REBOOT" == "true" ]]; then 
    echo -e "\e[93mSlickStack updates complete! Automatic server reboot in progress... see you on the other side!\e[0m" >&2
    /bin/bash -c "/sbin/reboot"
else 
    echo -e "\e[36mSlickStack updates complete! Please reboot server using sudo reboot.\e[0m"
fi

####################################################################################################
#### SlickStack: External References Used To Improve This Script (Thanks, Interwebz) ###############
####################################################################################################

## Ref: https://linux.die.net/man/8/apt-get
## Ref: https://askubuntu.com/questions/1112555/is-apt-dist-upgrade-not-necessary-anymore
## Ref: https://unix.stackexchange.com/questions/467552/reboot-over-ssh/467996#467996
## Ref: https://askubuntu.com/questions/254129/how-to-display-all-apt-get-dpkgoptions-and-their-current-values
## Ref: https://serverfault.com/questions/48724/100-non-interactive-debian-dist-upgrade
## Ref: https://askubuntu.com/questions/938359/apt-get-install-remove-update-upgrade-via-cron-job
## Ref: http://manpages.ubuntu.com/manpages/trusty/man8/apt.8.html
## Ref: https://www.debian.org/doc/manuals/apt-guide/index.en.html
## Ref: https://serverfault.com/questions/478461/how-to-install-packages-with-apt-without-user-interaction
## Ref: https://serverfault.com/questions/644180/what-does-qq-argument-for-apt-get-mean
## Ref: https://superuser.com/questions/1438031/ubuntu-18-command-apt-get-dist-upgrade-qq-force-yes-deprecated
## Ref: https://superuser.com/questions/1412054/non-interactive-apt-upgrade
## Ref: https://serverfault.com/questions/227190/how-do-i-ask-apt-get-to-skip-any-interactive-post-install-configuration-steps
## Ref: https://bugzilla.redhat.com/show_bug.cgi?id=1253351
## Ref: https://kb.cloudberrylab.com/backup-mac-linux/silent-install-macos-and-linux-builds
## Ref: https://unix.stackexchange.com/questions/32533/debian-how-to-delay-configuration-when-installing-upgrading
## Ref: https://raymii.org/s/tutorials/Silent-automatic-apt-get-upgrade.html
## Ref: https://unix.stackexchange.com/questions/138504/setting-path-vs-exporting-path-in-bash-profile
## Ref: https://askubuntu.com/questions/578568/path-error-in-ubuntu
## Ref: https://stackoverflow.com/questions/38977713/what-is-snap-bin-directory-in-path-can-i-remove-it-from-path
## Ref: https://askubuntu.com/questions/1121495/add-snap-bin-to-path-used-by-systemd
## Ref: https://askubuntu.com/questions/163200/e-dpkg-was-interrupted-run-sudo-dpkg-configure-a
